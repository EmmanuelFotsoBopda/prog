#!/usr/bin/env python
# coding: utf-8

# In[8]:


import requests
import json
import time
from datetime import datetime

class WeatherCollector:
    def __init__(self, cities):
        self.cities = cities
        self.api_url = "https://api.open-meteo.com/v1/forecast"
        # Comprehensive weather code descriptions
        self.weather_map = {
            0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
            45: "Fog", 48: "Rime fog", 51: "Light drizzle", 53: "Moderate drizzle",
            61: "Slight rain", 63: "Moderate rain", 65: "Heavy rain", 95: "Thunderstorm"
        }

    def _get_condition(self, code):
        # Maps numeric codes to descriptions with a fallback value
        return self.weather_map.get(code, "Unspecified")

    def fetch_city_weather(self, lat, lon):
        # Parameters configured for current day hourly data
        query_params = {
            "latitude": lat, "longitude": lon,
            "current_weather": True,
            "hourly": "temperature_2m,precipitation_probability,weathercode",
            "timezone": "auto",
            "forecast_days": 1
        }
        try:
            resp = requests.get(self.api_url, params=query_params, timeout=12)
            resp.raise_for_status()
            return resp.json()
        except requests.RequestException as error:
            print(f"Connection error for coordinates ({lat}, {lon}): {error}")
            return None

    def transform_data(self, raw_json, city_info):
        # Extracts and structures raw API response into desired schema
        try:
            current = raw_json.get("current_weather", {})
            hourly = raw_json.get("hourly", {})
            
            # Zip hourly data lists into structured dictionaries
            forecast_list = [
                {
                    "time": t, "temperature": temp, 
                    "precipitation_probability": prob, "weathercode": code,
                    "condition": self._get_condition(code)
                }
                for t, temp, prob, code in zip(
                    hourly.get("time", []), 
                    hourly.get("temperature_2m", []), 
                    hourly.get("precipitation_probability", []), 
                    hourly.get("weathercode", [])
                )
            ]

            return {
                "country": city_info["country"],
                "coordinates": {"latitude": raw_json.get("latitude"), "longitude": raw_json.get("longitude")},
                "current_weather": {
                    "temperature": current.get("temperature"),
                    "windspeed": current.get("windspeed"),
                    "weathercode": current.get("weathercode"),
                    "condition": self._get_condition(current.get("weathercode")),
                    "time": current.get("time")
                },
                "hourly_forecast": forecast_list
            }
        except Exception as e:
            print(f"Transformation failed for {city_info['city']}: {e}")
            return None

    def run_collection(self, output_name="eu_weather_data.json"):
        final_results = {}
        print("Starting batch weather retrieval...")

        for idx, entry in enumerate(self.cities, 1):
            name = entry["city"]
            print(f"[{idx}/{len(self.cities)}] Processing: {name}")
            
            raw_data = self.fetch_city_weather(entry["lat"], entry["lon"])
            if raw_data:
                processed = self.transform_data(raw_data, entry)
                if processed:
                    final_results[name] = processed
            
            # Delay to prevent API rate limiting issues
            time.sleep(1)

        # Persistence with UTF-8 encoding and indentation
        with open(output_name, "w", encoding="utf-8") as f:
            json.dump(final_results, f, indent=4, ensure_ascii=False)
        
        self._print_summary(final_results)

    def _print_summary(self, data):
        # Generates basic terminal statistics from the collected dataset
        if not data: return
        temps = [v["current_weather"]["temperature"] for v in data.values()]
        if temps:
            print(f"\nReport saved. Average EU Capital Temp: {sum(temps)/len(temps):.2f}Â°C")

if __name__ == "__main__":
    # EU Capitals List from source
    CAPITALS_DATA = [
        {"city": "Vienna", "country": "Austria", "lat": 48.2082, "lon": 16.3738},
        {"city": "Brussels", "country": "Belgium", "lat": 50.8503, "lon": 4.3517},
        {"city": "Sofia", "country": "Bulgaria", "lat": 42.6977, "lon": 23.3219},
        {"city": "Zagreb", "country": "Croatia", "lat": 45.8150, "lon": 15.9819},
        {"city": "Nicosia", "country": "Cyprus", "lat": 35.1856, "lon": 33.3823},
        {"city": "Prague", "country": "Czechia", "lat": 50.0755, "lon": 14.4378},
        {"city": "Copenhagen", "country": "Denmark", "lat": 55.6761, "lon": 12.5683},
        {"city": "Tallinn", "country": "Estonia", "lat": 59.4370, "lon": 24.7536},
        {"city": "Helsinki", "country": "Finland", "lat": 60.1695, "lon": 24.9354},
        {"city": "Paris", "country": "France", "lat": 48.8566, "lon": 2.3522},
        {"city": "Berlin", "country": "Germany", "lat": 52.5200, "lon": 13.4050},
        {"city": "Athens", "country": "Greece", "lat": 37.9838, "lon": 23.7275},
        {"city": "Budapest", "country": "Hungary", "lat": 47.4979, "lon": 19.0402},
        {"city": "Dublin", "country": "Ireland", "lat": 53.3498, "lon": -6.2603},
        {"city": "Rome", "country": "Italy", "lat": 41.9028, "lon": 12.4964},
        {"city": "Riga", "country": "Latvia", "lat": 56.9496, "lon": 24.1052},
        {"city": "Vilnius", "country": "Lithuania", "lat": 54.6872, "lon": 25.2797},
        {"city": "Luxembourg", "country": "Luxembourg", "lat": 49.6116, "lon": 6.1319},
        {"city": "Valletta", "country": "Malta", "lat": 35.8989, "lon": 14.5146},
        {"city": "Amsterdam", "country": "Netherlands", "lat": 52.3676, "lon": 4.9041},
        {"city": "Warsaw", "country": "Poland", "lat": 52.2297, "lon": 21.0122},
        {"city": "Lisbon", "country": "Portugal", "lat": 38.7223, "lon": -9.1393},
        {"city": "Bucharest", "country": "Romania", "lat": 44.4268, "lon": 26.1025},
        {"city": "Bratislava", "country": "Slovakia", "lat": 48.1486, "lon": 17.1077},
        {"city": "Ljubljana", "country": "Slovenia", "lat": 46.0569, "lon": 14.5058},
        {"city": "Madrid", "country": "Spain", "lat": 40.4168, "lon": -3.7038},
        {"city": "Stockholm", "country": "Sweden", "lat": 59.3293, "lon": 18.0686}
    ]

    app = WeatherCollector(CAPITALS_DATA)
    app.run_collection()


# In[ ]:





# In[ ]:




